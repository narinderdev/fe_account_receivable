<!-- Global Loader -->
<app-loader [visible]="isComponentLoading"></app-loader>

<div class="collections-container">
  <div class="company-overdue-group">
    <!-- <div class="company-field">
      <label>Company</label>
      <span class="company-selected-text">
        {{
          selectedCompanyId
            ? 'Using the company selected in the navbar'
            : 'Select a company from the navbar to view data'
        }}
      </span>
    </div> -->

    <div class="overdue-box">
      <label>Company Overdue</label>
      <div class="amount">
        <ng-container *ngIf="!loadingCompanyOverdue; else companyOverdueLoading">
          ${{ companyOverdueAmount | number }}
        </ng-container>
        <ng-template #companyOverdueLoading>
          <span class="overdue-loading-text">Fetching...</span>
        </ng-template>
      </div>
    </div>

    <div class="action-buttons">
      <!-- <button class="btn-secondary" (click)="logCall()">Log Call</button> -->
      <button class="btn-primary" (click)="openPromisePopup()" *ngIf="canCreatePromise">
        New Promise
      </button>
      <button class="btn-primary" (click)="openDisputePopup()" *ngIf="canCreateDispute">
        New Dispute
      </button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <!-- <button class="tab" [class.active]="activeTab === 'credits'" (click)="setTab('credits')">
      Credits to Apply
    </button> -->

    <button
      class="tab"
      [class.active]="activeTab === 'collections'"
      (click)="setTab('collections')"
      *ngIf="canViewReminders"
    >
      Collections
    </button>

    <button
      class="tab"
      [class.active]="activeTab === 'followUps'"
      (click)="setTab('followUps')"
      *ngIf="canViewReminders"
    >
      Follow-up Reminders
    </button>

    <button
      class="tab"
      [class.active]="activeTab === 'promise'"
      (click)="setTab('promise')"
      *ngIf="canViewPromise"
    >
      Promise to Pay
    </button>

    <button
      class="tab"
      [class.active]="activeTab === 'disputes'"
      (click)="setTab('disputes')"
      *ngIf="canViewDisputes"
    >
      Disputes
    </button>
  </div>

  <div class="card" *ngIf="activeTab === 'collections' && canViewReminders">
    <div *ngIf="loadingFollowUp" class="promise-loader">
      <app-spinner></app-spinner>
    </div>

    <ng-container *ngIf="!loadingFollowUp">
      <div *ngIf="collectionsPagination.totalItems === 0" class="empty-text">
        No customers need follow ups.
      </div>

      <div class="table-scroll" *ngIf="collectionsPagination.totalItems > 0">
        <table class="data-table">
          <thead>
            <tr>
              <th>Customer</th>
              <!-- <th>Customer ID</th> -->
              <th>Overdue Amount</th>
              <!-- <th>Actions</th> -->
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let reminder of followUpReminders; let i = index">
              <td>
                <div class="customer-info">
                  <div
                    class="customer-initial"
                    [ngStyle]="{
                      backgroundColor: getInitialColor(i).background,
                      color: getInitialColor(i).color
                    }"
                  >
                    {{ reminder.customerName ? reminder.customerName[0] : '?' }}
                  </div>
                  <span class="customer-name">{{ reminder.customerName }}</span>
                </div>
              </td>
              <!-- <td>{{ reminder.id }}</td> -->
              <td><strong>${{ (reminder.overdueAmount || 0) | number : '1.2-2' }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div
        class="tab-pagination"
        *ngIf="collectionsPagination.totalPages > 1 && collectionsPagination.totalItems > 0"
      >
        <div class="pagination-wrapper">
          <div class="pagination-info">
            Showing {{ collectionsPagination.currentPage * collectionsPagination.pageSize + 1 }} to
            {{
              Math.min(
                (collectionsPagination.currentPage + 1) * collectionsPagination.pageSize,
                collectionsPagination.totalItems
              )
            }}
            of {{ collectionsPagination.totalItems }} results
          </div>

          <div class="pagination-controls">
            <button
              class="page-nav-btn"
              (click)="collectionsPrevPage()"
              [disabled]="collectionsPagination.currentPage === 0"
            >
              <img src="/assets/left.svg" alt="Previous" class="pagination-icon" />
            </button>

            <button
              *ngFor="let page of getPageNumbers(collectionsPagination)"
              class="page-number-btn"
              [class.active]="page === collectionsPagination.currentPage + 1"
              [class.ellipsis]="page === -1"
              (click)="page !== -1 && goToCollectionsPage(page - 1)"
              [disabled]="page === -1"
            >
              {{ page === -1 ? '...' : page }}
            </button>

            <button
              class="page-nav-btn"
              (click)="collectionsNextPage()"
              [disabled]="collectionsPagination.currentPage === collectionsPagination.totalPages - 1"
            >
              <img src="/assets/right.svg" alt="Next" class="pagination-icon" />
            </button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>


  <div class="card" *ngIf="activeTab === 'followUps' && canViewReminders">
    <div *ngIf="loadingOverdueInvoices" class="promise-loader">
      <app-spinner></app-spinner>
    </div>

    <ng-container *ngIf="!loadingOverdueInvoices">
      <div *ngIf="followUpsPagination.totalItems === 0" class="empty-text">
        No overdue invoices found.
      </div>

      <div class="table-scroll" *ngIf="followUpsPagination.totalItems > 0">
        <table class="data-table">
          <thead>
            <tr>
              <th>Invoice #</th>
              <th>Customer</th>
              <th>Invoice Date</th>
              <th>Due Date</th>
              <th>Total Amount</th>
              <th>Balance Due</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let invoice of overdueInvoices; let i = index">
              <td>{{ invoice.invoiceNumber }}</td>
              <td>
                <div class="customer-info">
                  <div
                    class="customer-initial"
                    [ngStyle]="{
                      backgroundColor: getInitialColor(i).background,
                      color: getInitialColor(i).color
                    }"
                  >
                    {{ invoice.customerName ? invoice.customerName[0] : '?' }}
                  </div>
                  <span class="customer-name">{{ invoice.customerName }}</span>
                </div>
              </td>
              <td>{{ invoice.invoiceDate | date : 'MMM d, y' }}</td>
              <td>{{ invoice.dueDate | date : 'MMM d, y' }}</td>
              <td>${{ invoice.totalAmount | number : '1.2-2' }}</td>
              <td>${{ invoice.balanceDue | number : '1.2-2' }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(invoice.status)">
                  {{ getStatusLabel(invoice.status) }}
                </span>
              </td>
              <td>
                <button
                  class="link-button"
                  *ngIf="!reminderSent[invoice.invoiceId]"
                  (click)="sendReminder(invoice.invoiceId)"
                >
                  <ng-container *ngIf="!reminderSending[invoice.invoiceId]; else reminderLoading">
                    Reminder
                  </ng-container>
                  <ng-template #reminderLoading>
                    <app-spinner></app-spinner>
                  </ng-template>
                </button>
                <span class="sent-text" *ngIf="reminderSent[invoice.invoiceId]">Sent</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div
        class="tab-pagination"
        *ngIf="followUpsPagination.totalPages > 1 && followUpsPagination.totalItems > 0"
      >
        <div class="pagination-wrapper">
          <div class="pagination-info">
            Showing {{ followUpsPagination.currentPage * followUpsPagination.pageSize + 1 }} to
            {{
              Math.min(
                (followUpsPagination.currentPage + 1) * followUpsPagination.pageSize,
                followUpsPagination.totalItems
              )
            }}
            of {{ followUpsPagination.totalItems }} results
          </div>

          <div class="pagination-controls">
            <button
              class="page-nav-btn"
              (click)="followUpsPrevPage()"
              [disabled]="followUpsPagination.currentPage === 0"
            >
              <img src="/assets/left.svg" alt="Previous" class="pagination-icon" />
            </button>

            <button
              *ngFor="let page of getPageNumbers(followUpsPagination)"
              class="page-number-btn"
              [class.active]="page === followUpsPagination.currentPage + 1"
              [class.ellipsis]="page === -1"
              (click)="page !== -1 && goToFollowUpsPage(page - 1)"
              [disabled]="page === -1"
            >
              {{ page === -1 ? '...' : page }}
            </button>

            <button
              class="page-nav-btn"
              (click)="followUpsNextPage()"
              [disabled]="followUpsPagination.currentPage === followUpsPagination.totalPages - 1"
            >
              <img src="/assets/right.svg" alt="Next" class="pagination-icon" />
            </button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <div class="card" *ngIf="activeTab === 'promise' && canViewPromise">
    <!-- <h3>Promise to Pay</h3> -->

    <div *ngIf="loadingPromiseToPay" class="promise-loader">
      <app-spinner></app-spinner>
    </div>

    <ng-container *ngIf="!loadingPromiseToPay">
      <div *ngIf="promisePagination.totalItems === 0" class="empty-text">
        No promises to pay have been logged.
      </div>

      <div class="table-scroll" *ngIf="promisePagination.totalItems > 0">
        <table class="data-table">
          <thead>
            <tr>
              <th>Customer</th>
              <!-- <th>Invoice #</th> -->
              <th>Amount</th>
              <th>Promise Date</th>
              <th>Status</th>
              <th>Notes</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let p of promiseToPayList; let i = index">
              <td>
                <div class="customer-info">
                  <div
                    class="customer-initial"
                    [ngStyle]="{
                      backgroundColor: getInitialColor(i).background,
                      color: getInitialColor(i).color
                    }"
                  >
                    {{ p?.customerName?.[0] || '?' }}
                  </div>
                  <span class="customer-name">{{ p.customerName }}</span>
                </div>
              </td>
              <td>
                <strong>${{ p.amountPromised | number : '1.2-2' }}</strong>
              </td>
              <td>{{ p.promiseDate | date : 'MMM d, y' }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(p.status)">
                  {{ getStatusLabel(p.status) }}
                </span>
              </td>
              <td>{{ p.notes || '--' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div
        class="tab-pagination"
        *ngIf="promisePagination.totalPages > 1 && promisePagination.totalItems > 0"
      >
        <div class="pagination-wrapper">
          <div class="pagination-info">
            Showing {{ promisePagination.currentPage * promisePagination.pageSize + 1 }} to
            {{
              Math.min(
                (promisePagination.currentPage + 1) * promisePagination.pageSize,
                promisePagination.totalItems
              )
            }}
            of {{ promisePagination.totalItems }} results
          </div>

          <div class="pagination-controls">
            <button
              class="page-nav-btn"
              (click)="promisePrevPage()"
              [disabled]="promisePagination.currentPage === 0"
            >
              <img src="/assets/left.svg" alt="Previous" class="pagination-icon" />
            </button>

            <button
              *ngFor="let page of getPageNumbers(promisePagination)"
              class="page-number-btn"
              [class.active]="page === promisePagination.currentPage + 1"
              [class.ellipsis]="page === -1"
              (click)="page !== -1 && goToPromisePage(page - 1)"
              [disabled]="page === -1"
            >
              {{ page === -1 ? '...' : page }}
            </button>

            <button
              class="page-nav-btn"
              (click)="promiseNextPage()"
              [disabled]="promisePagination.currentPage === promisePagination.totalPages - 1"
            >
              <img src="/assets/right.svg" alt="Next" class="pagination-icon" />
            </button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <div class="card" *ngIf="activeTab === 'disputes' && canViewDisputes">
    <div *ngIf="loadingDisputes" class="promise-loader">
      <app-spinner></app-spinner>
    </div>

    <ng-container *ngIf="!loadingDisputes">
      <div *ngIf="disputesPagination.totalItems === 0" class="empty-text">
        No disputes have been logged.
      </div>

      <div class="table-scroll" *ngIf="disputesPagination.totalItems > 0">
        <table class="data-table">
          <thead>
            <tr>
              <th>Dispute ID</th>
              <th>Customer</th>
              <th>Invoice</th>
              <th>Invoice Amount</th>
              <th>Disputed Amount</th>
              <th>Status</th>
              <th>Reason</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let dispute of disputes; let i = index">
              <td>{{ dispute.disputeId }}</td>
              <td>
                <div class="customer-info">
                  <div
                    class="customer-initial"
                    [ngStyle]="{
                      backgroundColor: getInitialColor(i).background,
                      color: getInitialColor(i).color
                    }"
                  >
                    {{ dispute.customer.customerName[0] || '?' }}
                  </div>
                  <span class="customer-name">{{ dispute.customer.customerName || '--' }}</span>
                </div>
              </td>
              <td>{{ dispute.invoice.invoiceNumber }}</td>
              <td>${{ dispute.invoiceOriginalAmount | number : '1.2-2' }}</td>
              <td>${{ dispute.disputedAmount | number : '1.2-2' }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(dispute.status)">
                  {{ getStatusLabel(dispute.status) }}
                </span>
              </td>
              <td>{{ dispute.reason || '--' }}</td>
              <td>
                <button class="link-button" (click)="viewDisputeDetail(dispute.id)">View</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div
        class="tab-pagination"
        *ngIf="disputesPagination.totalPages > 1 && disputesPagination.totalItems > 0"
      >
        <div class="pagination-wrapper">
          <div class="pagination-info">
            Showing {{ disputesPagination.currentPage * disputesPagination.pageSize + 1 }} to
            {{
              Math.min(
                (disputesPagination.currentPage + 1) * disputesPagination.pageSize,
                disputesPagination.totalItems
              )
            }}
            of {{ disputesPagination.totalItems }} results
          </div>

          <div class="pagination-controls">
            <button
              class="page-nav-btn"
              (click)="disputesPrevPage()"
              [disabled]="disputesPagination.currentPage === 0"
            >
              <img src="/assets/left.svg" alt="Previous" class="pagination-icon" />
            </button>

            <button
              *ngFor="let page of getPageNumbers(disputesPagination)"
              class="page-number-btn"
              [class.active]="page === disputesPagination.currentPage + 1"
              [class.ellipsis]="page === -1"
              (click)="page !== -1 && goToDisputesPage(page - 1)"
              [disabled]="page === -1"
            >
              {{ page === -1 ? '...' : page }}
            </button>

            <button
              class="page-nav-btn"
              (click)="disputesNextPage()"
              [disabled]="disputesPagination.currentPage === disputesPagination.totalPages - 1"
            >
              <img src="/assets/right.svg" alt="Next" class="pagination-icon" />
            </button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- <div class="card" *ngIf="activeTab === 'reminders'">
    <div class="table-scroll">
      <table class="data-table">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Due Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of followUpReminders">
            <td>{{ r.customer }}</td>
            <td>{{ r.dueDate }}</td>
            <td class="highlight">{{ r.action }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div> -->

  <div class="modal-overlay" *ngIf="showPromisePopup">
    <div class="promise-modal">
      <!-- HEADER -->
      <div class="modal-header">
        <h2 class="modal-title">Create Promise to Pay</h2>
        <button class="btn-close" (click)="closePromisePopup()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- BODY -->
      <div class="modal-body">
        <div class="form-row">
          <!-- CUSTOMER -->
          <div class="form-field">
            <label>Customer <span class="color">*</span></label>
            <select [(ngModel)]="selectedCustomerId" (change)="onCustomerChange()">
              <option value="">Select customer</option>
              <option *ngFor="let c of customers" [value]="c.id">
                {{ c.customerName }}
              </option>
            </select>
            <p class="error" *ngIf="submitted && !selectedCustomerId">Customer is required</p>
          </div>

          <!-- OVERDUE AMOUNT -->
          <div class="form-field">
            <label>Overdue Amount <span class="color">*</span></label>
            <div class="overdue-display">
              <ng-container *ngIf="!loadingOverdue">
                ${{ overdueAmount | number : '1.2-2' }}
              </ng-container>
              <ng-container *ngIf="loadingOverdue">
                <app-spinner></app-spinner>
              </ng-container>
            </div>
          </div>
        </div>

        <div class="form-row">
          <!-- AMOUNT -->
          <div class="form-field">
            <label>Promise Amount <span class="color">*</span></label>
            <input type="number" [(ngModel)]="amountPromised" placeholder="0.00" step="0.01" />
            <p class="error" *ngIf="submitted && amountPromised === null">Amount is required</p>
            <p class="error" *ngIf="submitted && (amountPromised ?? 0) <= 0">
              Amount must be greater than 0
            </p>
            <p class="error" *ngIf="submitted && (amountPromised ?? 0) > overdueAmount">
              Amount cannot exceed overdue
            </p>
          </div>

          <!-- PAYMENT DATE -->
          <div class="form-field">
            <label>Payment Date <span class="color">*</span></label>
            <input type="date" [(ngModel)]="promiseDate" />
            <p class="error" *ngIf="submitted && !promiseDate">Payment date is required</p>
          </div>
        </div>

        <!-- REMARKS -->
        <div class="form-field full-width">
          <label>Remarks (Optional)</label>
          <textarea
            placeholder="Add any notes about this promise..."
            [(ngModel)]="notes"
            rows="4"
          ></textarea>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closePromisePopup()">Cancel</button>
        <button class="btn-save" [disabled]="savingPromise" (click)="savePromise()">
          <app-spinner *ngIf="savingPromise"></app-spinner>
          <span *ngIf="!savingPromise">Save Promise</span>
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showDisputePopup">
    <div class="promise-modal">
      <div class="modal-header">
        <h2 class="modal-title">New Dispute</h2>
        <button class="btn-close" (click)="closeDisputePopup()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-row">
          <div class="form-field">
            <label>Customer <span class="color">*</span></label>
            <select
              [(ngModel)]="selectedDisputeCustomerId"
              (change)="onDisputeCustomerChange()"
              [disabled]="loadingDisputeCustomers"
            >
              <option value="">Select customer</option>
              <option *ngFor="let customer of disputeCustomers" [value]="customer.id">
                {{ customer.customerName }}
              </option>
            </select>
            <p class="error" *ngIf="disputeSubmitted && !selectedDisputeCustomerId">
              Customer is required
            </p>
          </div>

          <div class="form-field">
            <label>Invoice <span class="color">*</span></label>
            <select
              [(ngModel)]="selectedDisputeInvoiceId"
              (change)="onDisputeInvoiceChange()"
              [disabled]="loadingDisputeInvoices || !selectedDisputeCustomerId"
            >
              <option value="">Select invoice</option>
              <option *ngFor="let invoice of disputeInvoices" [value]="invoice.id">
                {{ invoice.invoiceNumber }}
              </option>
            </select>
            <p class="error" *ngIf="disputeSubmitted && !selectedDisputeInvoiceId">
              Invoice is required
            </p>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>Invoice Amount</label>
            <input type="number" [value]="disputeInvoiceAmount || 0" placeholder="0.00" readonly />
          </div>

          <div class="form-field">
            <label>Disputed Amount <span class="color">*</span></label>
            <input
              type="number"
              [(ngModel)]="disputedAmount"
              placeholder="0.00"
              min="0"
              step="0.01"
            />
            <p class="error" *ngIf="disputeSubmitted && (!disputedAmount || disputedAmount <= 0)">
              Amount must be greater than 0
            </p>
            <p
              class="error"
              *ngIf="
                disputeSubmitted &&
                disputeInvoiceAmount !== null &&
                (disputedAmount || 0) > disputeInvoiceAmount
              "
            >
              Amount cannot exceed invoice amount
            </p>
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label>Dispute Code <span class="color">*</span></label>
            <select [(ngModel)]="selectedDisputeCode">
              <option value="">Select dispute code</option>
              <option *ngFor="let code of disputeCodes" [value]="code.code">
                {{ code.label }}
              </option>
            </select>
            <p class="error" *ngIf="disputeSubmitted && !selectedDisputeCode">
              Dispute code is required
            </p>
          </div>

          <div class="form-field">
            <label>Resolution Date <span class="color">*</span></label>
            <input type="date" [(ngModel)]="resolutionDate" [min]="minResolutionDate" />
            <p class="error" *ngIf="disputeSubmitted && !resolutionDate">
              Resolution date is required
            </p>
            <p class="error" *ngIf="disputeSubmitted && resolutionDate && isResolutionDatePast()">
              Resolution date cannot be in the past
            </p>
          </div>
        </div>

        <div class="form-field full-width">
          <label>Reason <span class="color">*</span></label>
          <textarea
            [(ngModel)]="disputeReason"
            rows="4"
            placeholder="Enter dispute reason"
          ></textarea>
          <p class="error" *ngIf="disputeSubmitted && !disputeReason.trim()">Reason is required</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeDisputePopup()">Cancel</button>
        <button class="btn-save" (click)="saveDispute()">
          <span>Submit Dispute</span>
        </button>
      </div>
    </div>
  </div>
</div>
