<div class="roles-container">
  <div class="roles-header" *ngIf="canCreateRoles">
    <button class="btn-add" (click)="openModal()">Add Role</button>
  </div>

  <app-spinner *ngIf="isLoading"></app-spinner>

  <!-- ROLES TABLE -->
  <div class="roles-table-wrapper" *ngIf="!isLoading && pagination.totalItems > 0">
    <table class="roles-table">
      <thead>
        <tr>
          <th>Role Name</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of roles">
          <td>{{ r.name }}</td>
          <td>{{ r.description }}</td>
          <td>
            <button class="link-button" type="button" (click)="viewRole(r)">View</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination-wrapper" *ngIf="pagination.totalPages > 1">
      <div class="pagination-info">
        Showing {{ pagination.currentPage * pagination.pageSize + 1 }} to
        {{
          Math.min(
            (pagination.currentPage + 1) * pagination.pageSize,
            pagination.totalItems
          )
        }}
        of {{ pagination.totalItems }} results
      </div>

      <div class="pagination-controls">
        <button class="page-nav-btn" (click)="prevPage()" [disabled]="pagination.currentPage === 0">
          <img src="/assets/left.svg" alt="Previous" class="pagination-icon" />
        </button>

        <button
          *ngFor="let page of getPageNumbers()"
          class="page-number-btn"
          [class.active]="page === pagination.currentPage + 1"
          [class.ellipsis]="page === -1"
          (click)="page !== -1 && goToPage(page - 1)"
          [disabled]="page === -1"
        >
          {{ page === -1 ? '...' : page }}
        </button>

        <button
          class="page-nav-btn"
          (click)="nextPage()"
          [disabled]="pagination.currentPage === pagination.totalPages - 1"
        >
          <img src="/assets/right.svg" alt="Next" class="pagination-icon" />
        </button>
      </div>
    </div>
  </div>

  <p *ngIf="!isLoading && pagination.totalItems === 0" class="section-description">No roles found.</p>
</div>

<!-- ADD ROLE MODAL -->
<div class="modal-backdrop" *ngIf="isModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <h3>Add Role</h3>
        <p class="modal-subtitle" *ngIf="getSelectedCount() > 0">
          {{ getSelectedCount() }} permission(s) selected
        </p>
      </div>
      <button class="close-btn" type="button" aria-label="Close" (click)="closeModal()">
        &times;
      </button>
    </div>

    <form [formGroup]="addRoleForm" (ngSubmit)="saveRole()" class="modal-body">
      <div class="form-field">
        <label>Name</label>
        <input type="text" formControlName="name" placeholder="e.g. Collections Manager" />
        <div class="error" *ngIf="submitted && addRoleForm.controls['name'].errors">Required</div>
      </div>

      <div class="form-field">
        <label>Description</label>
        <textarea
          formControlName="description"
          placeholder="Describe what this role can do"
        ></textarea>
        <div class="error" *ngIf="submitted && addRoleForm.controls['description'].errors">
          Required
        </div>
      </div>

      <div class="form-field">
        <label>Permissions</label>
        <div class="permissions-table-wrapper">
          <table class="permissions-table">
            <thead>
              <tr>
                <th class="module-col">Module</th>
                <th class="permission-col">View</th>
                <th class="permission-col">Create</th>
                <th class="permission-col">Update</th>
                <th class="permission-col">Delete</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of permissionRows" [class.sub-row]="row.isSubRow">
                <td class="module-name" [class.sub-module]="row.isSubRow">
                  {{ row.label }}
                </td>
                <td class="permission-cell">
                  <label class="checkbox-wrapper" *ngIf="row.permissions.view">
                    <input
                      type="checkbox"
                      [checked]="isPermissionSelected(row.permissions.view)"
                      [disabled]="isPermissionRequired(row.permissions.view)"
                      (change)="togglePermissionSelection(row.permissions.view)"
                    />
                  </label>
                </td>
                <td class="permission-cell">
                  <label class="checkbox-wrapper" *ngIf="row.permissions.create">
                    <input
                      type="checkbox"
                      [checked]="isPermissionSelected(row.permissions.create)"
                      (change)="togglePermissionSelection(row.permissions.create)"
                    />
                  </label>
                </td>
                <td class="permission-cell">
                  <label class="checkbox-wrapper" *ngIf="row.permissions.update">
                    <input
                      type="checkbox"
                      [checked]="isPermissionSelected(row.permissions.update)"
                      (change)="togglePermissionSelection(row.permissions.update)"
                    />
                  </label>
                </td>
                <td class="permission-cell">
                  <label class="checkbox-wrapper" *ngIf="row.permissions.delete">
                    <input
                      type="checkbox"
                      [checked]="isPermissionSelected(row.permissions.delete)"
                      (change)="togglePermissionSelection(row.permissions.delete)"
                    />
                  </label>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="isSaving">
          <app-spinner *ngIf="isSaving"></app-spinner>
          <span *ngIf="!isSaving">Create Role</span>
        </button>
      </div>
    </form>
  </div>
</div>
