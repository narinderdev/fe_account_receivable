<div class="roles-container">
  <div class="roles-header">
    <button class="btn-add" (click)="openModal()">Add Role</button>
  </div>

  <app-spinner *ngIf="isLoading"></app-spinner>

  <!-- ROLES TABLE -->
  <div class="roles-table-wrapper" *ngIf="!isLoading && roles.length > 0">
    <table class="roles-table">
      <thead>
        <tr>
          <th>Role Name</th>
          <th>Description</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of roles">
          <td>{{ r.name }}</td>
          <td>{{ r.description }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <p *ngIf="!isLoading && roles.length === 0" class="section-description">
    No roles found.
  </p>
</div>

<!-- ADD ROLE MODAL -->
<div class="modal-backdrop" *ngIf="isModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <h3>Add Role</h3>
      </div>
      <button class="close-btn" type="button" aria-label="Close" (click)="closeModal()">&times;</button>
    </div>

    <form [formGroup]="addRoleForm" (ngSubmit)="saveRole()" class="modal-body">
      <div class="form-field">
        <label>Name</label>
        <input type="text" formControlName="name" placeholder="e.g. Collections Manager" />
        <div class="error" *ngIf="submitted && addRoleForm.controls['name'].errors">Required</div>
      </div>

      <div class="form-field">
        <label>Description</label>
        <textarea formControlName="description" placeholder="Describe what this role can do"></textarea>
        <div class="error" *ngIf="submitted && addRoleForm.controls['description'].errors">
          Required
        </div>
      </div>

      <div class="form-field">
        <label>Permissions</label>
        <div class="permissions-grid">
          <!-- Regular tabs -->
          <div class="permission-row" *ngFor="let tab of permissionTabs">
            <div class="row-label">{{ tab.label }}</div>
            <div class="row-permissions">
              <label class="permission-checkbox" *ngFor="let perm of tab.permissions">
                <input
                  type="checkbox"
                  [checked]="isPermissionSelected(perm.code)"
                  (change)="togglePermissionSelection(perm.code)"
                />
                <span>{{ perm.label }}</span>
              </label>
              
              <!-- Subtabs (for Collections & Disputes) -->
              <div class="subtabs-inline" *ngIf="tab.subtabs && tab.subtabs.length > 0">
                <div class="subtab-inline" *ngFor="let subtab of tab.subtabs">
                  <span class="subtab-name">{{ subtab.label }}:</span>
                  <label class="permission-checkbox" *ngFor="let perm of subtab.permissions">
                    <input
                      type="checkbox"
                      [checked]="isPermissionSelected(perm.code)"
                      (change)="togglePermissionSelection(perm.code)"
                    />
                    <span>{{ perm.label }}</span>
                  </label>
                  <!-- <span class="coming-soon" *ngIf="subtab.permissions.length === 0">Coming soon</span> -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="selected-permissions" *ngIf="selectedPermissionLabels().length > 0">
          <span class="chip" *ngFor="let label of selectedPermissionLabels()">{{ label }}</span>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="isSaving">
          <app-spinner *ngIf="isSaving"></app-spinner>
          <span *ngIf="!isSaving">Create Role</span>
        </button>
      </div>
    </form>
  </div>
</div>